<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.northstar.bi.dao.BoardDao">
	
	<resultMap type="Board" id="BoardResultMap">
		<id column="BOARD_NO" property="NO"/>
		<result column="CATE_NO" property="CATE_NO"/>
		<result column="CATE_NAME" property="CATE_NAME"/>
		<result column="EMP_ID" property="EMP_ID"/>
		<result column="EMP_NAME" property="EMP_NAME"/>
		<result column="BOARD_TITLE" property="TITLE"/>
		<result column="BOARD_CREATE_DATE" property="CREATE_DATE"/>
		<result column="BOARD_CONTENT" property="CONTENT"/>
		<result column="BOARD_COUNT" property="COUNT"/>
		<result column="BOARD_FLAG" property="FLAG"/>
		<result column="BOARD_UPDATER" property="UPDATER"/>
		<result column="BOARD_UPDATE_DATE" property="UPDATE_DATE"/>
		<collection property="FILES" column="BOARD_NO" javaType="java.util.ArrayList" ofType="BoardFile" select="com.northstar.bi.dao.FileDao.getFileByNo"/>
		<collection property="REPLYS" column="BOARD_NO" javaType="java.util.ArrayList" ofType="int" select="com.northstar.bi.dao.BoardDao.getReplybyNo"/>
	</resultMap>
	
	
	
	<insert id="insertBoard" parameterType="Board">
		<selectKey keyProperty="NO" resultType="int" order="AFTER">
			SELECT BI_BOARD_SEQ.currval FROM DUAL
		</selectKey>
		insert into BI_BOARD
		(BOARD_NO,CATE_NO,EMP_ID,BOARD_TITLE,BOARD_CREATE_DATE,BOARD_CONTENT,BOARD_COUNT,BOARD_FLAG,BOARD_UPDATER,BOARD_UPDATE_DATE)
		values
		(BI_BOARD_SEQ.nextval, #{CATE}, #{ID}, #{TITLE}, sysdate, #{CONTENT},0,'Y',NULL,NULL)
	</insert>
	
	<select id="getTotalRows" resultType="int">
		select 
			count(*)
		from
			BI_BOARD A, BI_CATEGORY B , BI_EMP C
		where
			A.CATE_NO = B.CATE_NO and A.EMP_ID = C.EMP_ID
			<if test="TITLE != null &amp;&amp; TITLE !=''">
				and A.BOARD_TITLE like '%' || #{TITLE} || '%'
			</if>
			<if test="ID != null &amp;&amp; ID !=''">
				and C.EMP_NAME like '%' || #{ID} || '%'
			</if>
			<if test="CATE != 0">
			<choose>
					<when test="CATE == 1">
						and B.CATE_NO = '1'
					</when>
					<when test="CATE == 2">
						and B.CATE_NO = '2'
					</when>
					<when test="CATE == 3">
						and B.CATE_NO = '3'
					</when>
				</choose>
			</if>
		order by BOARD_NO desc
	</select>
	
	<select id="getBoardList" parameterType="BoardCriteria" resultType="Board">
		select 
				BOARD_NO as NO,
				CATE_NO,
				CATE_NAME,
				EMP_NAME,
				BOARD_TITLE as TITLE,
				BOARD_CREATE_DATE as CREATE_DATE,
				BOARD_CONTENT as CONTENT,
				BOARD_COUNT as COUNT,
				BOARD_FLAG as FLAG,
				BOARD_UPDATER as UPDATER,
				BOARD_UPDATE_DATE as UPDATE_DATE
		from 
			(
				select
					A.BOARD_NO,
					B.CATE_NO,
					B.CATE_NAME,
					C.EMP_NAME,
					A.EMP_ID,
					A.BOARD_TITLE,
					A.BOARD_CREATE_DATE,
					A.BOARD_CONTENT,
					A.BOARD_COUNT,
					A.BOARD_FLAG,
					A.BOARD_UPDATER,
					A.BOARD_UPDATE_DATE,
					row_number() over (order by BOARD_NO desc) rn
				from
					BI_BOARD A, BI_CATEGORY B,BI_EMP C
				where
					A.CATE_NO = B.CATE_NO and A.EMP_ID = C.EMP_ID
					<if test="TITLE != null &amp;&amp; TITLE !=''">
						and A.BOARD_TITLE like '%' || #{TITLE} || '%'
					</if>
					<if test="ID != null &amp;&amp; ID !=''">
						and C.EMP_NAME like '%' || #{ID} || '%'
					</if>
					<if test="CATE != 0">
						<choose>
							<when test="CATE == 1">
								and CATE_NAME = '문서'
							</when>
							<when test="CATE == 2">
								and CATE_NAME = '교육'
							</when>
							<when test="CATE == 3">
								and CATE_NAME = '영어'
							</when>
						</choose>
						</if>	
			)
		where
			rn &gt;= #{beginIndex} and rn &lt;= #{endIndex}	and BOARD_FLAG = 'Y'
		order by
			BOARD_NO desc	
	</select>
	<select id="getBoardByNo" parameterType="int" resultMap="BoardResultMap">
		select 
			BOARD.BOARD_NO,
			CATE.CATE_NO,
			CATE.CATE_NAME,
			EMP.EMP_NAME,
			BOARD.EMP_ID,
			BOARD.BOARD_TITLE,
			BOARD.BOARD_CREATE_DATE,
			BOARD.BOARD_CONTENT,
			BOARD.BOARD_COUNT,
			BOARD.BOARD_FLAG,
			BOARD.BOARD_UPDATER,
			BOARD.BOARD_UPDATE_DATE
		from
			BI_BOARD BOARD, 
			BI_CATEGORY CATE,
			BI_EMP EMP
		where
			BOARD.CATE_NO = CATE.CATE_NO 
		and BOARD.EMP_ID = EMP.EMP_ID 
		and BOARD.BOARD_NO = #{value}
	</select>
	
	<update id="updateBoard" parameterType="Board">
		update
			BI_BOARD
		set
			CATE_NO				= #{CATE_NO},
			BOARD_TITLE			= #{TITLE},
			BOARD_CONTENT		= #{CONTENT},
			BOARD_UPDATER		= #{UPDATER},
			BOARD_UPDATE_DATE	= SYSDATE
		where
			BOARD_NO = #{NO}
	</update>
	
	<delete id="deleteBoard" parameterType="Board">
		update
			BI_BOARD
		set
			BOARD_FLAG = 'N'
		where
			BOARD_NO = #{value}
	</delete>
	
	<update id="updateCnt" parameterType="int">
		update 
			BI_BOARD
		set
			BOARD_COUNT = NVL(BOARD_COUNT, 0) + 1
		where
            BOARD_NO = #{value}

	</update>





	<insert id="insertBoardReply" parameterType="BoardReply">
		insert into BI_BOARD_REPLY
			(REPLY_NO,BOARD_NO,EMP_ID,REPLY_CREATE_DATE,REPLY_CONTENT)
		values
			(REP_BOARD_SEQ.nextval,#{BOARD_NO},#{ID},sysdate,#{CONTENT})
	</insert>
	<select id="getReplybyNo" parameterType="int" resultType="BoardReply">
		select 
			REPLY_NO as NO,
			BOARD_NO,
			EMP_ID as ID,
			REPLY_CREATE_DATE as CREATE_DATE,
			REPLY_CONTENT as CONTENT
		from
			BI_BOARD_REPLY
		where
			BOARD_NO = #{value}
	</select>
	<delete id="deleteBoardReply" parameterType="int">
		delete from
			BI_BOARD_REPLY
		where
			REPLY_NO = #{value}
	</delete>

</mapper>